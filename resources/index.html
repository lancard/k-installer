<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Security-Policy" content="
        default-src
            'self'
            'unsafe-inline'
            https://cdnjs.cloudflare.com
            https://lancard.github.io
            https://github.com
            https://api.github.com
            https://raw.githubusercontent.com;
         script-src
            'self'
            'unsafe-inline'
            https://cdnjs.cloudflare.com;">
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>K-Installer</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/startbootstrap-sb-admin-2/4.1.4/css/sb-admin-2.min.css"
        integrity="sha512-Mk4n0eeNdGiUHlWvZRybiowkcu+Fo2t4XwsJyyDghASMeFGH6yUXcdDI3CKq12an5J8fq4EFzRVRdbjerO3RmQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css" />

    <!-- for loading jQuery -->
    <script>
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"
        integrity="sha512-pumBsjNRGGqkPzKHndZMaAG+bir374sORyzM3uulLV14lN5LyykqNk8eEeUlUkB3U0M4FApyaHraT65ihJhDpQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"
        integrity="sha512-hcV6DX35BKgiTiWYrJgPbu3FxS6CsCjKgmrsPRpUPkXWbvPiKxvSVSdhWX0yXcPctOI2FJ4WP6N1zH+17B/sAA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- for loading jQuery -->
    <script>
        if (window.module) module = window.module;
    </script>
</head>

<body>
    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="sidebar">

            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="javascript: void(0)"
                onclick="showMenu('home')">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-plane"></i>
                </div>
                <div class="sidebar-brand-text mx-3" style="font-family: 'FontAwesome';">K-Installer</div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

            <!-- Heading -->
            <div class="sidebar-heading mb-2 mt-4">
                <i class="fas fa-fw fa-tree"></i> Scenery and Chart
            </div>

            <li class="nav-item">
                <a class="nav-link" href="javascript: void(0)" onclick="showMenu('RKJY')">
                    <span class="font-weight-bold">RKJY</span>
                    <small class="d-none d-lg-inline"> Yeosu airport</small>
                    <span updateIcon="RKJY" class="d-none" update-mark-RKJY-fs2020-scenery update-mark-RKJY-p3d-scenery>
                        <sup class="text-warning">up<i class="fas fa-turn-up text-warning"></i></sup>
                    </span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="javascript: void(0)" onclick="showMenu('RKPK')">
                    <span class="font-weight-bold">RKPK</span>
                    <small class="d-none d-lg-inline"> Gimhae airport</small>
                    <span updateIcon="RKPK" class="d-none">
                        <sup class="text-warning">up<i class="fas fa-turn-up text-warning"></i></sup>
                    </span>
                </a>
            </li>

            <!-- Heading -->
            <div class="sidebar-heading mb-2 mt-4">
                <i class="fas fa-fw fa-wand-magic-sparkles"></i> ATC Program
            </div>
            <li class="nav-item">
                <a class="nav-link" href="javascript: void(0)" onclick="showMenu('KRW')">
                    <span class="font-weight-bold">KRW</span>
                    <small class="d-none d-lg-inline"> Korean weather radar</small>
                    <span updateIcon="KRW" class="d-none">
                        <sup class="text-warning">up<i class="fas fa-turn-up text-warning"></i></sup>
                    </span>
                </a>
            </li>

            <!-- Divider -->
            <div class="bottom-copyright">
                <hr class="sidebar-divider d-none d-md-block" style="margin-top: 40px;">

                <li class="nav-item">
                    <a class="nav-link" href="javascript:void(0)" role="button"
                        onclick="alert('w_o_r_s_t_r_o_c_k_e_r@gmail.com plz. (delete underscore before send)')">
                        <i class="fas fa-envelope fa-fw"></i>
                        <span class="mx-2">Email to me</span>
                    </a>
                </li>

                <!-- Nav Item - Github -->
                <li class="nav-item dropdown no-arrow mx-1">
                    <a class="nav-link dropdown-toggle" href="javascript:void(0)" id="messagesDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                        onclick="require('child_process').execSync('start https://github.com/lancard')">
                        <i class="fa-brands fa-github"></i>
                        <span class="mx-2">Github Link</span>
                    </a>
                </li>

                <li class="nav-item dropdown no-arrow mx-1 my-4 text-center">
                    <small><span>Copyright &copy; Sungho Kim 2023</span></small>
                </li>
            </div>
        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column p-2">

            <!-- Main Content -->
            <div id="content">

                <!-- start of container-->
                <div class="container-fluid collapse" id="KRW">
                    <div class="m-1">
                        <h2 class="m-2">
                            <i class="fa-solid fa-plane-departure"></i>
                            KRW - Euroscope plugin Korean Radar for Weather
                        </h2>
                    </div>

                    <div class="row p-4">
                        <div class="col-auto">
                            <img src="https://lancard.github.io/k-installer/KRW.png" width="400" class="m-1"
                                style="box-shadow: 5px 5px 10px #000; border-radius: 25px;">
                        </div>
                        <div class="col mx-0 my-4">
                            <h4>How to install</h4>
                            <ul class="airport-description">
                                <li>Download & Unzip downloaded file</li>
                                <li>Run euroscope and menu - plugin</li>
                                <li>Load dll</li>
                            </ul>
                            <div class="mx-4">
                                <button type="button" class="btn btn-success mx-2"
                                    onclick="updateScenery2020('RKJY', 'master')">Install / Update</button>
                                <button type="button" class="btn btn-danger mx-2"
                                    onclick="removeScenery2020('RKJY')">Remove</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end of container -->


                <!-- start of container-->
                <div class="container-fluid collapse" id="RKJY">
                    <div class="m-1">
                        <h2 class="m-2">
                            <i class="fa-solid fa-plane-departure"></i>
                            RKJY - Yeosu airport
                        </h2>
                    </div>

                    <div class="row p-4">
                        <div class="col-auto">
                            <img src="https://lancard.github.io/k-installer/RKJY.png" width="400" class="m-1"
                                style="box-shadow: 5px 5px 10px #000; border-radius: 25px;">
                        </div>
                        <div class="col mx-0 my-4">
                            <ul class="airport-description">
                                <li>ICAO: <strong>RKJY</strong></li>
                                <li>Name: <strong>Yeosu airport</strong></li>
                            </ul>
                        </div>
                    </div>

                    <hr />

                    <h4 class="mx-4">
                        <i class="fa-solid fa-tree"></i> Scenery
                    </h4>
                    <div class="row">
                        <div class="col">
                            <div class="card m-4">
                                <div class="card-header">
                                    <i class="fa-solid fa-people-carry-box"></i> FS2020
                                </div>
                                <div class="card-body text-center">
                                    <ul class="airport-description text-left">
                                        <li>Author: <strong>ArtistPilot</strong></li>
                                        <li>License: <strong>mail to ArtistPilot</strong></li>
                                        <li>Latest version: <strong latestVersion="RKJY-fs2020-scenery"></strong></li>
                                        <li>Installed version: <strong installedVersion="RKJY-fs2020-scenery"></strong>
                                        </li>
                                        <li>Installed directory: <strong
                                                installedDirectory="RKJY-fs2020-scenery"></strong>
                                        </li>
                                    </ul>

                                    <button downloadButton="RKJY-fs2020-scenery" type="button"
                                        class="btn btn-success mx-2"
                                        onclick="upgradeProgram('RKJY-fs2020-scenery')">Install / Update</button>
                                    <button downloadButton="RKJY-fs2020-scenery" type="button"
                                        class="btn btn-danger mx-2"
                                        onclick="removeProgram('RKJY-fs2020-scenery')">Remove</button>
                                    <div downloadStatus="RKJY-fs2020-scenery" class="collapse">
                                        <h4 statusMessage class="text-primary">Download in progress...</h4>
                                        <h4>Download: <span transferred>0</span></h4>
                                        <h4>Speed: <span speed>0</span> MB/s</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card m-4">
                                <div class="card-header">
                                    <i class="fa-solid fa-people-carry-box"></i> FSX/P3D
                                </div>
                                <div class="card-body text-center">
                                    <ul class="airport-description text-left">
                                        <li>Author: <strong>VFR GO!</strong></li>
                                        <li>License: <strong>contact VFR GO!</strong></li>
                                        <li>Latest version: <strong latestVersion="RKJY-p3d-scenery"></strong></li>
                                        <li>Installed version: <strong installedVersion="RKJY-p3d-scenery"></strong>
                                        </li>
                                        <li>Installed directory: <strong installedDirectory="RKJY-p3d-scenery"></strong>
                                        </li>
                                    </ul>

                                    <button downloadButton="RKJY-p3d-scenery" type="button" class="btn btn-success mx-2"
                                        onclick="upgradeProgram('RKJY-p3d-scenery')">Install specific directory</button>
                                    <button downloadButton="RKJY-p3d-scenery" type="button" class="btn btn-danger mx-2"
                                        onclick="removeProgram('RKJY-p3d-scenery')">Remove</button>

                                    <div downloadStatus="RKJY-p3d-scenery" class="collapse">
                                        <h4 statusMessage class="text-primary">Download in progress...</h4>
                                        <h4>Download: <span transferred>0</span></h4>
                                        <h4>Speed: <span speed>0</span> MB/s</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card m-4">
                                <div class="card-header">
                                    <i class="fa-solid fa-people-carry-box"></i> XPLANE
                                </div>
                                <div class="card-body text-center">
                                    <span class="text-danger">Not available</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end of container -->

                <!-- start of container-->
                <div class="container-fluid collapse" id="RKPK">
                    <div class="m-1">
                        <h2 class="m-2">
                            <i class="fa-solid fa-plane-departure"></i>
                            RKPK - Gimhae airport
                        </h2>
                    </div>

                    <div class="row p-4">
                        <div class="col-auto">
                            <img src="https://lancard.github.io/k-installer/RKPK.png" width="400" class="m-1"
                                style="box-shadow: 5px 5px 10px #000; border-radius: 25px;">
                        </div>
                        <div class="col mx-0 my-4">
                            <ul class="airport-description">
                                <li>ICAO: <strong>RKPK</strong></li>
                                <li>Name: <strong>Gimhae airport</strong></li>
                                <li>Author: <strong>Sungho Kim (3D object contribution: Hongsda)</strong></li>
                                <li>License: <strong>Contact me</strong></li>
                                <hr class="my-2" />
                                <li>Latest version: <strong latestVersion></strong></li>
                                <li>Installed version: <strong installedVersion></strong></li>
                            </ul>
                            <div class="mx-4">
                                <button type="button" class="btn btn-success mx-2"
                                    onclick="updateScenery2020('RKPK', 'master')">Install / Update</button>
                                <button type="button" class="btn btn-danger mx-2"
                                    onclick="removeScenery2020('RKPK')">Remove</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end of container -->


                <div class="container-fluid" id="home">
                    <div class="m-1">
                        <h2 class="m-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            Welcome to Korea Program and Scenery Installer
                        </h2>
                    </div>

                    <div class="row p-4">
                        <div class="col-auto">
                            <img src="https://lancard.github.io/k-installer/airport.png"
                                style="box-shadow: 5px 5px 10px #000; border-radius: 25px; width: 30vw;">

                            <div class="map-overlay" onclick="showMenu('RKJY')" style="top: 36.2vw; left: 14vw;">
                                <div class="bg-gray-800"><i class="fa-solid fa-plane"></i> RKJY</div>
                                <hr class="m-0" style="border-color: white;">
                                <div>Yeosu</div>
                            </div>
                            <div class="map-overlay" onclick="showMenu('RKPK')" style="top: 34.2vw; left: 20vw;">
                                <div class="bg-gray-800"><i class="fa-solid fa-plane"></i> RKPK</div>
                                <hr class="m-0" style="border-color: white;">
                                <div>Gimhae</div>
                            </div>
                        </div>
                        <div class="col">
                            <div downloadStatusProgram class="collapse m-4 p-4 bg-dark">
                                <h2 statusMessage class="text-primary">Download in progress...</h2>
                                <h4>Download: <span transferred>0</span></h4>
                                <h4>Speed: <span speed>0</span> MB/s</h4>
                            </div>

                            <div class="card m-4">
                                <div class="card-header">
                                    <i class="fa-solid fa-people-carry-box"></i> Installer Version
                                </div>
                                <div class="card-body">
                                    <span id="programVersion">(Loading)</span>
                                </div>
                            </div>

                            <div class="card m-4">
                                <div class="card-header">
                                    <i class="fa-solid fa-people-carry-box"></i> FS2020 Community Folder
                                </div>
                                <div class="card-body">
                                    <span id="communityDirectory">(Loading)</span>
                                    <button type="button" class="btn btn-primary mx-4 p-2"
                                        onclick="require('child_process').execSync('explorer '+communityDirectory);">Open
                                        in explorer</button>
                                </div>
                            </div>
                        </div>
                    </div>



                </div>

            </div>
        </div>

    </div>

    <script src="common.js"></script>
    <script>
        var programInfo = {
            "k-installer": {
                versionCheckUrl: "https://lancard.github.io/k-installer/package.json",
                versionModifier: (data) => data.version
            },
            "RKJY-fs2020-scenery": {
                downloadUrl: "https://github.com/lancard/fs2020-RKJY/archive/master.zip",
                versionCheckUrl: "https://lancard.github.io/fs2020-RKJY/version.txt",
                versionModifier: (data) => data.trim(),
                unzippedRootDirectory: "fs2020-RKJY-master",
                targetDirectoryNotExistMessage: "install fs2020 first",
                targetDirectory: communityDirectory,
                localStorageNameOfInstalledVersion: "RKJY-fs2020-scenery-installed-version",
                localStorageNameOfInstalledRootDirectory: "RKJY-fs2020-scenery-installed-directory",
                localStorageNameOfInstalledDirectoryList: "RKJY-fs2020-scenery-installed-directory-list",
                directory: {
                    "rkjy-airport-scene": `fs2020-RKJY-master\\rkjy-airport-scene`,
                    "rkjy": `fs2020-RKJY-master\\rkjy`,
                    "zulu-airport-rkjy-yeosu": `fs2020-RKJY-master\\zulu-airport-rkjy-yeosu`
                }
            },
            "RKJY-p3d-scenery": {
                downloadUrl: "https://github.com/lancard/VFRGO/releases/download/master/VFRGO_Yeosu.zip",
                versionCheckUrl: "https://api.github.com/repos/lancard/VFRGO/releases/latest",
                versionModifier: (data) => data.assets[2].updated_at,
                unzippedRootDirectory: ".",
                localStorageNameOfInstalledVersion: "RKJY-p3d-scenery-installed-version",
                localStorageNameOfInstalledRootDirectory: "RKJY-p3d-scenery-installed-directory",
                localStorageNameOfInstalledDirectoryList: "RKJY-p3d-scenery-installed-directory-list",
                directory: {
                    "scenery": "RKJY-p3d-scenery\\scenery",
                    "texture": "RKJY-p3d-scenery\\texture"
                }
            },
            "RKPK-fs2020-scenery": {
                downloadUrl: "https://github.com/lancard/fs2020-RKPK/archive/master.zip",
                versionFileName: "https://lancard.github.io/fs2020-RKPK/version.txt",
                directory: {
                    "Packages\\thekoreans-airport-rkpk-busan": `${communityDirectory}\\thekoreans-airport-rkpk-busan`
                }
            },
            "RKPK-p3d-scenery": {
                directory: {
                    "Packages\\thekoreans-airport-rkpk-busan": `${communityDirectory}\\thekoreans-airport-rkpk-busan`
                }
            }
        };


        function updateScreen(id) {
            $(`[latestVersion="${id}"]`).text(programInfo[id].latestVersion);

            if (!isInstalledBefore(id)) {
                $(`[installedVersion="${id}"]`).text("(not installed)");
                $(`[installedDirectory="${id}"]`).text("(not installed)");
                $(`[update-mark-${id}]`).addClass(`must-show-${id}`);
                return;
            }

            $(`[installedVersion="${id}"]`).text(programInfo[id].installedVersion);
            var installedDirectoryList = JSON.parse(localStorage.getItem(programInfo[id].localStorageNameOfInstalledDirectoryList)).join(", ");
            $(`[installedDirectory="${id}"]`).text(installedDirectoryList);

            if (programInfo[id].latestVersion == programInfo[id].installedVersion) {
                $(`[update-mark-${id}]`).removeClass(`must-show-${id}`);
            }
            else {
                $(`[update-mark-${id}]`).addClass(`must-show-${id}`);
            }
        }


        function checkUpdate(id) {
            if (!programInfo[id].versionCheckUrl)
                return;

            $.get(programInfo[id].versionCheckUrl, (data) => {
                const latestVersion = programInfo[id].versionModifier ? programInfo[id].versionModifier(data) : data;
                const installedVersion = localStorage.getItem(programInfo[id].localStorageNameOfInstalledVersion);

                programInfo[id].installedVersion = installedVersion;
                programInfo[id].latestVersion = latestVersion;

                updateScreen(id);
            });
        }

        function isInstalledBefore(id) {
            return localStorage.getItem(programInfo[id].localStorageNameOfInstalledRootDirectory) != null;
        }

        function removeProgram(id) {
            if (!isInstalledBefore(id))
                return;

            const installedDirectoryArray = JSON.parse(localStorage.getItem(programInfo[id].localStorageNameOfInstalledDirectoryList));

            // remove first
            installedDirectoryArray.forEach(e => {
                fs.rmSync(e, { recursive: true, force: true });
            });

            // remove storage
            localStorage.removeItem(programInfo[id].localStorageNameOfInstalledRootDirectory);
            localStorage.removeItem(programInfo[id].localStorageNameOfInstalledDirectoryList);
            localStorage.removeItem(programInfo[id].localStorageNameOfInstalledVersion);

            programInfo[id].installedVersion = null;

            // update screen
            updateScreen(id);
        }

        function installProgram(id, targetDirectory) {
            const filename = `${targetDirectory}\\${id}.zip`;

            $buttons = $(`[downloadButton="${id}"]`);
            $status = $(`[downloadStatus="${id}"]`);

            $buttons.hide();
            $status.show();
            $status.find("[statusMessage]").text("downloading...");

            downloadFile(filename, programInfo[id].downloadUrl,
                () => {
                    $status.find("[statusMessage]").text("decompressing...");

                    decompress(filename, targetDirectory)
                        .then((files) => {
                            fs.rmSync(filename); // remove zip file for disk space

                            // replacement for unzipped files
                            var installedDirectory = [];
                            for (var dir in programInfo[id].directory) {
                                moveSync(`${targetDirectory}\\${programInfo[id].unzippedRootDirectory}\\${dir}`, `${targetDirectory}\\${programInfo[id].directory[dir]}`);
                                installedDirectory.push(`${targetDirectory}\\${programInfo[id].directory[dir]}`);
                            }

                            if (programInfo[id].unzippedRootDirectory != ".") {
                                fs.rmSync(programInfo[id].unzippedRootDirectory, { recursive: true, force: true }); // remove zip root directory
                            }

                            // save installed information
                            localStorage.setItem(programInfo[id].localStorageNameOfInstalledRootDirectory, targetDirectory);
                            localStorage.setItem(programInfo[id].localStorageNameOfInstalledDirectoryList, JSON.stringify(installedDirectory));
                            localStorage.setItem(programInfo[id].localStorageNameOfInstalledVersion, programInfo[id].latestVersion);

                            programInfo[id].installedVersion = programInfo[id].latestVersion;

                            alert(`installation complete: ${id}`);

                            // restore hide elements
                            $buttons.show();
                            $status.hide();

                            // check update again
                            updateScreen(id);
                        })
                        .catch((error) => {
                            console.log(error);
                        });
                },
                (state) => {
                    updateDownloadStatus($status, state);
                });
        }

        function upgradeProgram(id) {
            var targetDir = localStorage.getItem(programInfo[id].localStorageNameOfInstalledRootDirectory);

            // installed before
            if (targetDir != null) {
                // remove first
                removeProgram(id);

                installProgram(id, targetDir);

                return;
            }

            // install first time ----------------------------------

            if (programInfo[id].targetDirectory != null) {

                installProgram(id, programInfo[id].targetDirectory);

            } else {
                if (programInfo[id].targetDirectoryNotExistMessage) {
                    alert(programInfo[id].targetDirectoryNotExistMessage);
                    return;
                }
                else {
                    alert("select 'addon scenery' folder (will create new folder)");
                    var ret = dialog.showOpenDialogSync({ properties: ["openDirectory"] });
                    if (!ret) {
                        alert('abort');
                        return;
                    }
                    if (!fs.existsSync(ret[0])) {
                        alert(`path not exist: ${ret[0]}`);
                        return;
                    }

                    installProgram(id, ret[0]);
                }
            }
        }

        function initialization() {
            if (communityDirectory == null) {
                $("#communityDirectory").addClass("text-danger");
                $("#communityDirectory").text("Not Found");
            }
            else {
                $("#communityDirectory").text(communityDirectory);
            }
            $("#programVersion").text(appVersion);

            // add stylesheet for update mark element
            for (var id in programInfo) {
                var style = $(`<style>.must-show-${id} { display: inline-block !important; }</style>`);
                $('html > head').append(style);
            }

            // check update
            for (var id in programInfo) {
                checkUpdate(id);
            }
        }

        function showMenu(selectedId) {
            $("div.container-fluid").hide(500);
            $("#" + selectedId).show(500);
        }

        initialization();
    </script>
</body>

</html>