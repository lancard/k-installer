<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Security-Policy" content="
        default-src
            'self'
            'unsafe-inline'
            https://cdnjs.cloudflare.com
            https://lancard.github.io
            https://github.com
            https://raw.githubusercontent.com;
         script-src
            'self'
            'unsafe-inline'
            https://cdnjs.cloudflare.com;">
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>K-Installer</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/startbootstrap-sb-admin-2/4.1.4/css/sb-admin-2.min.css"
        integrity="sha512-Mk4n0eeNdGiUHlWvZRybiowkcu+Fo2t4XwsJyyDghASMeFGH6yUXcdDI3CKq12an5J8fq4EFzRVRdbjerO3RmQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .sidebar {
            width: 20vw;
        }

        .sidebar .nav-item .nav-link {
            padding: 2px;
            padding-left: 30px;
        }

        .sidebar .nav-item .nav-link span {
            font-size: 1.3rem;
        }

        .sidebar .nav-item small {
            color: rgb(128, 128, 128);
        }

        .sidebar-heading {
            color: rgb(228, 228, 228) !important;
        }

        #wrapper #content-wrapper {
            background-color: #272b30;
            width: 100%;
            overflow-x: hidden;
            color: white;
        }

        #accordionSidebar {
            background-image: linear-gradient(90deg, #484e55, #3a3f44 60%, #272b30);
            background-color: #000000;
        }

        .card {
            border-color: #424242;
            background-color: #181818;
            margin: 5px;
        }

        .card-header {
            color: white;
            border-bottom: #424242;
            background-color: #000;
        }

        .card-body {
            color: white;
        }

        .map-overlay {
            position: absolute;
            width: 70px;
            background-color: rgba(255, 255, 255, 0.1);
            text-align: center;
            cursor: pointer;
        }

        .airport-description {
            color: rgb(128, 128, 128);
        }

        .airport-description strong {
            color: rgb(228, 228, 228);
        }
    </style>

    <!-- for loading jQuery -->
    <script>
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"
        integrity="sha512-pumBsjNRGGqkPzKHndZMaAG+bir374sORyzM3uulLV14lN5LyykqNk8eEeUlUkB3U0M4FApyaHraT65ihJhDpQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"
        integrity="sha512-hcV6DX35BKgiTiWYrJgPbu3FxS6CsCjKgmrsPRpUPkXWbvPiKxvSVSdhWX0yXcPctOI2FJ4WP6N1zH+17B/sAA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- for loading jQuery -->
    <script>
        if (window.module) module = window.module;
    </script>
</head>

<body>
    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="javascript: void(0)"
                onclick="showMenu('home')">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-plane"></i>
                </div>
                <div class="sidebar-brand-text mx-3">K-Installer</div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

            <!-- Heading -->
            <div class="sidebar-heading mb-2 mt-4">
                <i class="fas fa-fw fa-tree"></i> Chart for Korea
            </div>
            <li class="nav-item">
                <a class="nav-link" href="javascript: void(0)"
                    onclick="require('child_process').execSync('start https://lancard.github.io/chart/')">
                    <span class="font-weight-bold">Charts <i class="fas fa-fw fa-up-right-from-square"></i></span>
                </a>
            </li>


            <!-- Heading -->
            <div class="sidebar-heading mb-2 mt-4">
                <i class="fas fa-fw fa-tree"></i> Scenery For FS2020
            </div>

            <li class="nav-item">
                <a class="nav-link" href="javascript: void(0)" onclick="showMenu('RKJY')">
                    <span class="font-weight-bold">RKJY</span>
                    <small class="d-none d-lg-inline"> Yeosu airport</small>
                    <span updateIcon="RKJY" class="d-none"><sup class="text-warning">up<i
                                class="fas fa-turn-up text-warning"></i></sup></span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="javascript: void(0)" onclick="showMenu('RKPK')">
                    <span class="font-weight-bold">RKPK</span>
                    <small class="d-none d-lg-inline"> Gimhae airport</small>
                    <span updateIcon="RKPK" class="d-none"><sup class="text-warning">up<i
                                class="fas fa-turn-up text-warning"></i></sup></span>
                </a>
            </li>

            <!-- Heading -->
            <div class="sidebar-heading mb-2 mt-4">
                <i class="fas fa-fw fa-wand-magic-sparkles"></i> ATC Program
            </div>

            <!--
            <li class="nav-item">
                <a class="nav-link" href="javascript: void(0)" onclick="showMenu('RKPK')">
                    <span class="font-weight-bold">APU PAR</span>
                    <small class="d-none d-lg-inline"> PAR program</small>
                </a>
            </li>
            -->

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block" style="margin-top: 40px;">

            <li class="nav-item">
                <a class="nav-link" href="javascript:void(0)" role="button"
                    onclick="alert('w_o_r_s_t_r_o_c_k_e_r@gmail.com plz. (delete underscore before send)')">
                    <i class="fas fa-envelope fa-fw"></i>
                    <span class="mx-2 d-none d-lg-inline">Email to me</span>
                </a>
            </li>

            <!-- Nav Item - Github -->
            <li class="nav-item dropdown no-arrow mx-1">
                <a class="nav-link dropdown-toggle" href="javascript:void(0)" id="messagesDropdown" role="button"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                    onclick="require('child_process').execSync('start https://github.com/lancard')">
                    <i class="fa-brands fa-github"></i>
                    <span class="mx-2 d-none d-lg-inline">Github Link</span>
                </a>
            </li>

            <li class="nav-item dropdown no-arrow mx-1 my-4 text-center">
                <small><span>Copyright &copy; Sungho Kim 2023</span></small>
            </li>
        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column p-2">

            <!-- Main Content -->
            <div id="content">

                <!-- start of container-->
                <div class="container-fluid collapse" id="RKJY" data-url="">
                    <div class="m-4">
                        <h1 class="h3 mb-0">
                            <i class="fa-solid fa-plane-departure"></i>
                            RKJY - Yeosu airport
                        </h1>
                    </div>

                    <div class="row p-4">
                        <div class="col-auto">
                            <img src="https://github.com/lancard/k-installer/raw/master/resources/RKJY.png" width="500"
                                class="m-1" style="box-shadow: 5px 5px 10px #000; border-radius: 25px;">
                        </div>
                        <div class="col mx-0 my-4">
                            <ul class="airport-description">
                                <li>ICAO: <strong>RKJY</strong></li>
                                <li>Name: <strong>Yeosu airport</strong></li>
                                <li>Author: <strong>ArtistPilot</strong></li>
                                <li>License: <strong>mail to ArtistPilot</strong></li>
                                <hr class="my-2" />
                                <li>Latest version: <strong latestVersion></strong></li>
                                <li>Installed version: <strong installedVersion></strong></li>
                            </ul>
                            <div class="mx-4">
                                <button type="button" class="btn btn-success mx-2"
                                    onclick="updateScenery('RKJY', 'master')">Install / Update</button>
                                <button type="button" class="btn btn-danger mx-2"
                                    onclick="removeScenery('RKJY')">Remove</button>
                            </div>
                        </div>
                    </div>

                    <div downloadStatus class="collapse">
                        <h2 statusMessage class="text-primary">Download in progress...</h2>
                        <h4>Transferred: <span transferred>0</span> MB</h4>
                        <h4>Speed: <span speed>0</span> MB/s</h4>
                    </div>
                </div>
                <!-- end of container -->

                <!-- start of container-->
                <div class="container-fluid collapse" id="RKPK" data-url="">
                    <div class="m-4">
                        <h1 class="h3 mb-0">
                            <i class="fa-solid fa-plane-departure"></i>
                            RKPK - Gimhae airport
                        </h1>
                    </div>

                    <div class="row p-4">
                        <div class="col-auto">
                            <img src="https://github.com/lancard/k-installer/raw/master/resources/RKPK.png" width="500"
                                class="m-1" style="box-shadow: 5px 5px 10px #000; border-radius: 25px;">
                        </div>
                        <div class="col mx-0 my-4">
                            <ul class="airport-description">
                                <li>ICAO: <strong>RKPK</strong></li>
                                <li>Name: <strong>Gimhae airport</strong></li>
                                <li>Author: <strong>Sungho Kim (3D object contribution: Hongsda)</strong></li>
                                <li>License: <strong>Contact me</strong></li>
                                <hr class="my-2" />
                                <li>Latest version: <strong latestVersion></strong></li>
                                <li>Installed version: <strong installedVersion></strong></li>
                            </ul>
                            <div class="mx-4">
                                <button type="button" class="btn btn-success mx-2"
                                    onclick="updateScenery('RKPK', 'master')">Install / Update</button>
                                <button type="button" class="btn btn-danger mx-2"
                                    onclick="removeScenery('RKPK')">Remove</button>
                            </div>
                        </div>
                    </div>

                    <div downloadStatus class="collapse">
                        <h2 statusMessage class="text-primary">Download in progress...</h2>
                        <h4>Transferred: <span transferred>0</span> MB</h4>
                        <h4>Speed: <span speed>0</span> MB/s</h4>
                    </div>
                </div>
                <!-- end of container -->










                <div class="container-fluid" id="home">
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-white">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            Welcome to Korea Program and Scenery Installer
                        </h1>
                    </div>

                    <div class="row">
                        <div class="col-auto">
                            <img src="https://github.com/lancard/k-installer/raw/master/resources/airport.png"
                                style="box-shadow: 5px 5px 10px #000; border-radius: 25px; width: 30vw;">

                            <div class="map-overlay" onclick="showMenu('RKJY')" style="top: 36.2vw; left: 14vw;">
                                <div class="bg-gray-800"><i class="fa-solid fa-plane"></i> RKJY</div>
                                <hr class="m-0" style="border-color: white;">
                                <div>Yeosu</div>
                            </div>
                            <div class="map-overlay" onclick="showMenu('RKPK')" style="top: 34.2vw; left: 20vw;">
                                <div class="bg-gray-800"><i class="fa-solid fa-plane"></i> RKPK</div>
                                <hr class="m-0" style="border-color: white;">
                                <div>Gimhae</div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card m-4">
                                <div class="card-header">
                                    <i class="fa-solid fa-people-carry-box"></i> Installer Version
                                </div>
                                <div class="card-body">
                                    <span id="programVersion">(Loading)</span>
                                </div>
                            </div>

                            <div class="card m-4">
                                <div class="card-header">
                                    <i class="fa-solid fa-people-carry-box"></i> FS2020 Community Folder
                                </div>
                                <div class="card-body">
                                    <span id="communityDirectory">(Loading)</span>
                                    <button type="button" class="btn btn-primary mx-4 p-2"
                                        onclick="require('child_process').execSync('explorer '+communityDirectory);">Open
                                        in explorer</button>
                                </div>
                            </div>
                        </div>
                    </div>



                </div>

            </div>
        </div>

    </div>

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <script>
        // common library
        const appVersion = require('./package.json').version;
        const util = require('./util.js');
        var communityDirectory = util.getCommunityDirectory();
        if (communityDirectory == null)
            communityDirectory = "D:/test"; // for debug
        const { dialog } = require('electron');
        const path = require('path');
        const fs = require('fs');
        const decompress = require("decompress");
        const programInfo = {
            "RKJY": {
                id: "RKJY",
                repository: "fs2020-RKJY",
                directory: {
                    "rkjy-airport-scene": `${communityDirectory}/rkjy-airport-scene`,
                    "rkjy": `${communityDirectory}/rkjy`,
                    "zulu-airport-rkjy-yeosu": `${communityDirectory}/zulu-airport-rkjy-yeosu`
                }
            },
            "RKPK": {
                id: "RKPK",
                repository: "fs2020-RKPK",
                directory: {
                    "PackageSources/Scenery/airport-rkpk-busan": `${communityDirectory}/airport-rkpk-busan`
                }
            }
        };

        function checkUpdate() {
            $.getJSON(`https://raw.githubusercontent.com/lancard/k-installer/master/package.json`, (data) => {
                if (appVersion == data.version)
                    return;

                // update exist.
                if (!confirm(`install new version ${data.version}?`))
                    return;

                require('child_process').execSync('start https://github.com/lancard/k-installer/releases');
            });
        }


        function initialization() {
            if (communityDirectory == null) {
                $("#communityDirectory").addClass("text-danger");
                $("#communityDirectory").text("Not Found");
            }
            else {
                $("#communityDirectory").text(communityDirectory);
            }
            $("#programVersion").text(appVersion);

            // check update
            checkUpdate();

            for (var id in programInfo) {
                retrieveGitInfo(id);
            }
        }


        // functions ..................................

        function updateScreen(id) {
            $(`#${id} [latestVersion]`).text(programInfo[id]["date"]);
            $(`#${id} [installedVersion]`).text(localStorage.getItem(id));
            if (programInfo[id]["date"] != localStorage.getItem(id)) {
                $(`#${id} [latestVersion]`).addClass("text-danger");
                $(`[updateicon=${id}]`).removeClass("d-none");
            } else {
                $(`#${id} [latestVersion]`).removeClass("text-danger");
                $(`[updateicon=${id}]`).addClass("d-none");
            }
        }

        function retrieveGitInfo(id) {
            $.get(`https://lancard.github.io/${programInfo[id].repository}/version.txt`, (data) => {
                programInfo[id]["date"] = data;

                updateScreen(id);
            });
        }



        function showMenu(selectedId) {
            $("div.container-fluid").hide();
            $("#" + selectedId).show();
        }



        function removeScenery(id) {
            localStorage.removeItem(id);

            for (var dir in programInfo[id].directory) {
                fs.rmSync(programInfo[id].directory[dir], { recursive: true, force: true });
            };

            updateScreen(id);
        }

        function updateScenery(id, branch) {
            if (communityDirectory == null) {
                alert('install fs2020 first');
                return;
            }

            removeScenery(id);

            const filename = `${communityDirectory}/${id}.zip`;
            const unzippedDirName = `${communityDirectory}/${programInfo[id].repository}-${branch}`;

            $(`#${id}`).find("[downloadStatus]").show();
            $(`#${id}`).find("[downloadStatus] [statusMessage]").text("downloading...");

            util.downloadFile(filename, `https://github.com/lancard/${programInfo[id].repository}/archive/refs/heads/${branch}.zip`,
                () => {
                    $(`#${id}`).find("[downloadStatus] [statusMessage]").text("decompressing...");

                    decompress(filename, communityDirectory)
                        .then((files) => {
                            fs.rmSync(filename);
                            for (var dir in programInfo[id].directory) {
                                fs.renameSync(`${unzippedDirName}/${dir}`, programInfo[id].directory[dir]);
                            }
                            fs.rmSync(unzippedDirName, { recursive: true, force: true });
                            localStorage.setItem(id, programInfo[id].date);
                            $(`#${id}`).find("[downloadStatus]").hide();
                            updateScreen(id);
                            alert(`installation complete: ${id}`);
                        })
                        .catch((error) => {
                            console.log(error);
                        });
                },
                (state) => {
                    $(`#${id}`).find("[downloadStatus] [transferred]").text((state.size.transferred / 1024 / 1024).toFixed(2));
                    $(`#${id}`).find("[downloadStatus] [speed]").text((state.speed / 1024 / 1024).toFixed(2));
                });
        }

        initialization();
    </script>
</body>

</html>